---
title: "tirefittingr Notebook"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---


Disclaimer: All data and fit curves shown in this notebook are fictional. 

THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT PERMITTED BY
APPLICABLE LAW.  EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT
HOLDERS AND/OR OTHER PARTIES PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY
OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO,
THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
PURPOSE.  THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE PROGRAM
IS WITH YOU.  SHOULD THE PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF
ALL NECESSARY SERVICING, REPAIR OR CORRECTION.


Below is an example script for tire analysis.


Make sure you have downloaded and installed the package if you haven't already.
Installing only needs to be done once on a computer.

```{r eval=FALSE}
install.packages("devtools")
library(devtools) #devtools is needed for the install_github function
install_github("fsaer/tirefittingr") 

install.packages("plotly") #now is also the time to install plotly if you haven't already
```


Load the packages. This must be done every r-session, so this code is often
at the top of every script.
```{r echo=TRUE, message=FALSE, warning=FALSE}
library(tirefittingr)
```

```{r message=FALSE, warning=FALSE, include=TRUE}
library(plotly)
```


Let's get a list of files we want to fit. You can EITHER A) use files you have, 
in .csv or .dat file format, OR Option B) use built-in fake data set. B 
will be used for the rest of this example.

```{r warning=FALSE, include=TRUE}
#A Select files on computer 
#lRunNames = getTireRunList() 

#B Use built-in files
lRunNames = getTireRunList(c("ABCrun1LatPreProccessed", 
                             "ABCrun2LatPreProccessed"))

```

This created a list of files along with some information the program needs to
fit them. To view this file you can double click the object name in the 
"Environment" window (default is top right in RStudio) or run the command
```{r eval=FALSE, include=TRUE}
View(lRunNames)
```


We are going to speed up the solver a bit for this example. This will reduce the
quality of the fit.
```{r}
    #speed up solver.
    options(
        tirefittingr.iParallelCores = 1,
        tirefittingr.iEvolIterMax = 30, 
        tirefittingr.iDataPoints = 3000,
        tirefittingr.sSavePlotPath = FALSE,
        tirefittingr.bPlotRunConditions = TRUE,
        tirefittingr.sSummaryExportPath = NA)
```

At a minimum, we need to set the options telling the program whether we are 
fitting we need to set the starting population and tell it which fitting 
equation to use.
```{r}
#Required options
options(tirefittingr.sdfStartPop = "dfStartParFY")
options(tirefittingr.sfFittingFunction = "FYPurePacejka2002")

#Additional options we will run
options(tirefittingr.sfPreProcess = "FYPre")#FYPre pre-process functions
options(tirefittingr.sfPlot = "fFYPlot") #FY Plot goodness of fit

# Instead of manually setting these 4 options, we can call one function to
# set all 4 at one. 
setFYPure2002()

# #If we wanted to analyze FX, we could do the following
# options(tirefittingr.sdfStartPop = "dfStartParFX")
# options(tirefittingr.sfFittingFunction = "FXPurePacejka2002.NoIA")
# options(tirefittingr.sfPreProcess = "FXPre")
# options(tirefittingr.sfPlot = "fFXPlot.NoIA")
options(tirefittingr.iEvolIterMax = 20)
# #OR the simple function that sets all 4 at once:
# setFXPure2002.wIA()

```
For a full list of options see the help file for the tireFittingr function:
```{r eval=FALSE, include=TRUE}
?tireFittingr
```
Now we are ready to use the tire fitting function. 
## ISSUE: Plotting run conditions not working.
```{r}
dfFitSummary = fitTires(lRunNames)
```
After fitting, we can look at the output plots. In the run conditions plots, 
we can check that our tire got up to temperature, that it actually contains
IA sweeps, and the pressure is what we expected. 

In the goodness of fit plots, we can see how closely our fitted curve matches
the raw data. 


Great, now let's compare our two tires in basic FY vs Slip Angle plots. 
First, we will decide what sweeps of parameters will will be plotting.
```{r}
SAplot = seq(from = -12, to = 12, by = 0.05) #Slip angle in degrees
IAPlot = 0 #inclination angle in degrees
# FZ0Plot = -1600 #Nominal FZ value. -1600 is a good number. 
FZPlot = c(-250, -750, -1200) #FZ in Newtons
IAPlot = 0

#create a blank plot and set the legend at the top.
myPlot = plotly::layout(plot_ly(), 
                        legend = list(orientation = 'h', x = 0, y = 1.15))
    
```

The easiest way to create data frames that we can plot is by using the 
createFitDataFrame function. This function will evaluate our fitting function, 
in this case FYPurePAcejka2002, at every different combination of our SA, IA, 
and FZ inputs. 

We can learn more about this function with
```{r eval = FALSE}
?createFitDataFrame
```
After creating our data
```{r}
#Create a matrix that is easy to plot
mGridPlot = createFitDataFrame(FYPurePacejka2002, "parameters", SA = SAplot, 
    FZ = FZPlot, IA = IAPlot, parameters = dfFitSummary[1, 9:ncol(dfFitSummary)])

#add markers to the plot
myPlot = add_markers(myPlot, data = mGridPlot, x = ~SA, y = ~FY, 
    name = dfFitSummary[1, 1], marker = list(color = "blue"))
show(myPlot)
```

Let's create a second data frame to plot for our second data set, then plot it.
```{r}
#Create a matrix that is easy to plot
mGridPlot2 = createFitDataFrame(FYPurePacejka2002, "parameters", SA = SAplot, 
    FZ = FZPlot, IA = IAPlot, parameters = dfFitSummary[2, 9:ncol(dfFitSummary)])

#Add markers to the plot
myPlot = add_markers(myPlot, data = mGridPlot2, x = ~SA, y = ~FY, 
    name = dfFitSummary[2, 1], marker = list(color = "red"))
show(myPlot)
    
```

When we ran fitTires), we could have automatically exported the parameters
to a csv file by setting option tirefittingr.sSummaryExportPath equal to a 
string of a file path. Let's do that now, so we can practice re-opening an old 
parameters file.
```{r eval=FALSE, include=TRUE}
#enter a full file path using forward slashes / not backslashes.
print(getwd())
options(tirefittingr.sSummaryExportPath = getwd()) 

#fit the tires again
fitTireslRunNames)

```


You'll have to navigate in explorer to where the file was saved, and 
get the entire file path. Pro-top: In windows, holding ctrl and right click on 
the file will show the secret option "Copy as path". You can paste this into
R, but make sure to switch the backslashes to forward slashes. 
```{r include=TRUE}
readData = read.csv(
        file = "../data/FakeCoef.csv", #enter your path here.
        header = TRUE,
        as.is = TRUE,
        stringsAsFactors = FALSE)

```

We can now repeat what we did before, but with the two curves from our csv file.
```{r}
myPlot = plotly::layout(
    plot_ly(), #create blank plot
    legend = list(orientation = 'h', x = 0, y = 1.15)) #set legend

#Create a matrix that is easy to plot
mGridPlot1 = createFitDataFrame(FYPurePacejka2002, "parameters", SA = SAplot, 
    FZ = FZPlot, IA = IAPlot, parameters = readData[1, 9:ncol(readData)])

#add markers to the plot
myPlot = add_markers(myPlot, data = mGridPlot1, x = ~SA, y = ~FY, 
    name = readData[1, 1], marker = list(color = "blue"))

mGridPlot2 = createFitDataFrame(FYPurePacejka2002, "parameters", SA = SAplot, 
    FZ = FZPlot, IA = IAPlot, parameters = readData[2, 9:ncol(readData)])

myPlot = add_markers(myPlot, data = mGridPlot2, x = ~SA, y = ~FY, 
    name = readData[2, 1], marker = list(color = "red"))

show(myPlot)
```

While splitting up data sets into subsets based on pressure, etc is currently 
being developed, the splitTireData function works. Note the built-in data set
currently doesn't have a "P" column, so if you use the built in data, then 
it will fail.

```{r}
lRunNamesSplit = splitTireData(lRunNames, P = 6.894*c(8,10,12,14), verbose = FALSE)
```


